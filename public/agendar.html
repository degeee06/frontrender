<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar Compromisso</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.2/imask.min.js"></script>
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    :root {
        --black-absolute: #000000;
        --black-deep: #111111;
        --black-medium: #1A1A1A;
        --black-light: #333333;
        --white-pure: #FFFFFF;
        --white-ice: #E0E0E0;
        --gray-steel: #5A5A5A;
        --silver-accent: #C0C0C0;
        --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.3);
        --shadow-deep: 0 8px 40px rgba(0, 0, 0, 0.5);
    }
    
    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--black-absolute);
        color: var(--white-ice);
        min-height: 100vh;
        line-height: 1.6;
    }
    
    .glass-card {
        background-color: var(--black-medium);
        border: 1px solid var(--black-light);
        box-shadow: var(--shadow-soft);
        border-radius: 16px;
        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        position: relative;
        overflow: hidden;
    }
    
    .glass-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--silver-accent), transparent);
        opacity: 0.3;
    }
    
    .glass-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-deep);
        border-color: var(--gray-steel);
    }
    
    .input-field {
        transition: all 0.3s ease-out;
        font-size: 16px;
        background-color: var(--black-medium);
        border: 1px solid var(--black-light);
        color: var(--white-ice);
    }
    
    .input-field:focus {
        outline: none;
        border-color: var(--silver-accent);
        box-shadow: 0 0 0 2px rgba(192, 192, 192, 0.1);
        background-color: var(--black-light);
    }
    
    .loading-spinner {
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        border-top: 2px solid var(--white-ice);
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* üî• CORRE√á√ïES MOBILE CR√çTICAS */
    @media (max-width: 640px) {
        .container {
            padding-left: 12px;
            padding-right: 12px;
        }
        
        .glass-card {
            margin-left: 0;
            margin-right: 0;
            border-radius: 16px;
        }
        
        .input-field {
            font-size: 16px !important;
            padding-top: 14px !important;
            padding-bottom: 14px !important;
        }
        
        .mobile-w-full {
            width: 100%;
        }
        
        .mobile-flex-col {
            flex-direction: column;
        }
    }

    .success-message {
        background-color: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: #4ade80;
    }

    .error-message {
        background-color: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #f87171;
    }

    /* üî• CHAT FLUTUANTE NO CANTO DIREITO */
    .chat-flutuante {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 350px;
        height: 450px;
        background-color: var(--black-medium);
        border: 1px solid var(--black-light);
        border-radius: 16px;
        box-shadow: var(--shadow-deep);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .chat-header {
        background-color: var(--black-light);
        padding: 16px;
        color: var(--white-ice);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--black-light);
    }

    .chat-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
    }

    .chat-toggle {
        background: none;
        border: none;
        color: var(--white-ice);
        cursor: pointer;
        padding: 4px;
    }

    .chat-messages {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        background-color: var(--black-deep);
    }

    .chat-message {
        margin-bottom: 12px;
        padding: 10px 14px;
        border-radius: 12px;
        max-width: 85%;
        animation: fadeIn 0.3s ease;
    }

    .chat-bot {
        background-color: rgba(139, 92, 246, 0.2);
        border: 1px solid rgba(139, 92, 246, 0.3);
        margin-right: auto;
    }

    .chat-user {
        background-color: rgba(59, 130, 246, 0.2);
        border: 1px solid rgba(59, 130, 246, 0.3);
        margin-left: auto;
    }

    .chat-message-content {
        font-size: 14px;
        line-height: 1.5;
    }

    .chat-actions {
        padding: 16px;
        border-top: 1px solid var(--black-light);
        background-color: var(--black-medium);
    }

    .chat-btn-primary {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #10b981, #059669);
        border: none;
        border-radius: 10px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .chat-btn-primary:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }

    /* Bot√£o flutuante para abrir chat */
    .chat-abrir-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #6366f1, #3b82f6);
        border: none;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        z-index: 999;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .chat-abrir-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 12px 30px rgba(99, 102, 241, 0.6);
    }

    /* Estados do chat */
    .chat-fechado {
        transform: translateY(100px);
        opacity: 0;
        pointer-events: none;
    }

    .chat-aberto {
        transform: translateY(0);
        opacity: 1;
    }

    /* Grid de hor√°rios no chat */
    .horarios-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
        gap: 6px;
        margin-top: 8px;
    }

    .horario-btn {
        padding: 6px 8px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        font-size: 11px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .horario-btn:hover {
        background: rgba(59, 130, 246, 0.3);
        border-color: rgba(59, 130, 246, 0.5);
    }

    .horario-btn.selecionado {
        background: rgba(34, 197, 94, 0.3);
        border-color: rgba(34, 197, 94, 0.5);
    }

    .info-box {
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 8px;
        padding: 10px;
        margin: 8px 0;
        font-size: 12px;
    }

    .dia-section {
        margin-bottom: 12px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
    }

    .dia-titulo {
        font-weight: 600;
        margin-bottom: 6px;
        color: #60a5fa;
        font-size: 13px;
    }

    /* Responsivo */
    @media (max-width: 640px) {
        .chat-flutuante {
            width: calc(100vw - 40px);
            height: 70vh;
            bottom: 10px;
            right: 10px;
            left: 10px;
        }
        
        .chat-abrir-btn {
            bottom: 10px;
            right: 10px;
        }
    }

    /* üÜï ESTILOS PARA PER√çODOS BLOQUEADOS NO CHAT */
    .periodo-bloqueado-info {
        background: rgba(245, 158, 11, 0.1) !important;
        border: 1px solid rgba(245, 158, 11, 0.3) !important;
        color: #fbbf24 !important;
    }

    .horario-bloqueado {
        background: rgba(107, 114, 128, 0.3) !important;
        border-color: rgba(107, 114, 128, 0.5) !important;
        color: #9ca3af !important;
        cursor: not-allowed !important;
    }

    .horario-bloqueado:hover {
        background: rgba(107, 114, 128, 0.3) !important;
        transform: none !important;
    }

    .grupo-horarios {
        margin-bottom: 12px;
        padding: 8px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
    }

    .titulo-grupo {
        font-size: 11px;
        color: #fbbf24;
        margin-bottom: 6px;
        font-weight: 600;
    }

    /* üîî BADGE DE NOTIFICA√á√ÉO NO BOT√ÉO DO CHAT */
    .chat-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 11px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: pulse 2s infinite;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        z-index: 1001;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    .chat-badge.hidden {
        display: none;
    }

    /* üî• T√çTULOS COM GRADIENTE MINIMALISTA */
    .title-gradient {
        background: linear-gradient(135deg, var(--white-pure), var(--white-ice));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* üî• BOT√ÉO PREMIUM */
    .btn-premium {
        background: linear-gradient(135deg, #C0C0C0 0%, #9E9E9E 100%) !important;
        border: 1px solid #E0E0E0 !important;
        color: #000000 !important;
        box-shadow: 0 4px 12px rgba(192, 192, 192, 0.3) !important;
        font-weight: 600 !important;
        border-radius: 12px !important;
        transition: all 0.3s ease !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 12px !important;
    }

    .btn-premium:hover {
        background: linear-gradient(135deg, #E0E0E0 0%, #C0C0C0 100%) !important;
        border-color: #FFFFFF !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 16px rgba(192, 192, 192, 0.4) !important;
    }
      /* üî• CORRE√á√ÉO CR√çTICA - ESTILOS FALTANTES */
.ring-2 {
    box-shadow: 0 0 0 2px rgba(192, 192, 192, 0.3);
}

.ring-indigo-500\/30 {
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
}

/* üî• CORRE√á√ÉO - INPUTS COM COR DE TEXTO VIS√çVEL */
.input-field {
    color: #000000 !important;
    background-color: #ffffff !important;
}
    </style>
</head>
<body class="min-h-screen">
    <!-- üéØ CONTE√öDO PRINCIPAL üéØ -->
    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <!-- Header -->
        <header class="text-center mb-8" data-aos="fade-down">
            <div class="flex justify-center mb-3">
                <h1 class="text-3xl md:text-4xl font-bold title-gradient">
                    Agendar Compromisso
                </h1>
            </div>
            <p class="text-lg opacity-90">
                Preencha os dados para agendar seu compromisso
            </p>
        </header>
        
        <!-- üî• BOT√ÉO CORRIGIDO - CHAT FLUTUANTE NO CANTO DIREITO -->
        <button class="chat-abrir-btn" id="chatAbrirBtn">
            <i data-feather="message-circle"></i>
            <div id="chatBadge" class="chat-badge hidden">!</div>
        </button>

        <div id="chatFlutuante" class="chat-flutuante chat-fechado">
            <!-- Cabe√ßalho do Chat -->
            <div class="chat-header">
                <h3>üí¨ Assistente de Agendamento</h3>
                <button class="chat-toggle" id="chatFecharBtn">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <!-- Mensagens do Chat -->
            <div id="chatMessages" class="chat-messages">
                <div class="chat-message chat-bot">
                    <div class="chat-message-content">
                        <strong>Assistente:</strong> Ol√°! Posso ajudar voc√™ a encontrar hor√°rios dispon√≠veis! üòä
                    </div>
                </div>
            </div>
            
            <!-- A√ß√µes do Chat -->
            <div class="chat-actions">
                <button class="chat-btn-primary" id="carregarHorariosBtn">
                    <span>üîç Ver Hor√°rios Dispon√≠veis</span>
                </button>
            </div>
        </div>

       <!-- Formul√°rio de Agendamento -->
<form id="agendarForm" class="glass-card rounded-2xl p-6 md:p-8 mb-6" data-aos="fade-up">
    <div class="text-center mb-6">
        <div class="w-16 h-16 mx-auto mb-3 rounded-full bg-gradient-to-br from-blue-500 to-cyan-400 border border-cyan-300 shadow-lg flex items-center justify-center">
            <i data-feather="calendar" class="w-6 h-6 text-white"></i>
        </div>
        <h2 class="text-xl font-bold title-gradient mb-1">Agendar Compromisso</h2>
        <p class="text-gray-400 text-sm">Preencha os dados abaixo</p>
    </div>
    
    <!-- Separador Elegante -->
    <div class="h-px bg-gradient-to-r from-transparent via-gray-600 to-transparent mb-6"></div>
    
    <div class="space-y-5">
        <!-- Nome -->
        <div>
            <label for="nome" class="block mb-2 text-sm font-medium text-gray-300">Nome Completo</label>
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i data-feather="user" class="w-5 h-5 text-gray-400"></i>
                </div>
                <input type="text" id="nome" placeholder="Seu nome completo" required 
                       class="w-full pl-10 pr-4 py-3 rounded-lg bg-white border border-gray-300 focus:border-cyan-400 focus:outline-none text-black text-sm">
            </div>
        </div>

        <!-- Email (OPCIONAL) -->
        <div>
            <label for="email" class="block mb-2 text-sm font-medium text-gray-300">Email <span class="text-gray-400 text-xs">(opcional)</span></label>
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i data-feather="mail" class="w-5 h-5 text-gray-400"></i>
                </div>
                <input type="email" id="email" placeholder="email (opcional)" 
                       class="w-full pl-10 pr-4 py-3 rounded-lg bg-white border border-gray-300 focus:border-cyan-400 focus:outline-none text-black text-sm">
            </div>
        </div>

        <!-- Telefone -->
        <div>
            <label for="telefone" class="block mb-2 text-sm font-medium text-gray-300">Telefone</label>
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i data-feather="phone" class="w-5 h-5 text-gray-400"></i>
                </div>
                <input type="tel" id="telefone" placeholder="(00) 00000-0000" required 
                       class="w-full pl-10 pr-4 py-3 rounded-lg bg-white border border-gray-300 focus:border-cyan-400 focus:outline-none text-black text-sm">
            </div>
        </div>

        <!-- Data e Hor√°rio -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="data" class="block mb-2 text-sm font-medium text-gray-300">Data</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-feather="calendar" class="w-5 h-5 text-gray-400"></i>
                    </div>
                    <input type="date" id="data" placeholder="Data do Agendamento" required 
                           class="w-full pl-10 pr-4 py-3 rounded-lg bg-white border border-gray-300 focus:border-cyan-400 focus:outline-none text-black text-sm">
                </div>
            </div>
            <div>
                <label for="horario" class="block mb-2 text-sm font-medium text-gray-300">Hor√°rio</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-feather="clock" class="w-5 h-5 text-gray-400"></i>
                    </div>
                    <input type="time" id="horario" placeholder="Hor√°rio" required 
                           class="w-full pl-10 pr-4 py-3 rounded-lg bg-white border border-gray-300 focus:border-cyan-400 focus:outline-none text-black text-sm">
                </div>
            </div>
        </div>

                <!-- Bot√£o Agendar -->
                <button type="submit" class="w-full px-4 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-cyan-400 hover:from-blue-600 hover:to-cyan-500 transition-all duration-300 text-white font-semibold flex items-center justify-center gap-2 mt-6">
                    <i data-feather="plus" class="w-4 h-4"></i>
                    <span id="agendarText">Agendar Compromisso</span>
                    <div id="agendarSpinner" class="loading-spinner hidden"></div>
                </button>
            </div>
        </form>

        <!-- Resultado -->
        <div id="resultado" class="glass-card rounded-2xl p-6 text-center" data-aos="fade-up" style="display: none;">
            <!-- Mensagens aparecem aqui -->
        </div>
    </div>

    <script>
        // Inicializa Feather Icons
        feather.replace();
        
        // üî• CONFIGURA EVENT LISTENERS DO CHAT
        document.getElementById('chatAbrirBtn').addEventListener('click', toggleChat);
        document.getElementById('chatFecharBtn').addEventListener('click', toggleChat);
        document.getElementById('carregarHorariosBtn').addEventListener('click', carregarHorariosReais);
        
        // Inicializa AOS
        AOS.init({
            duration: 800,
            once: true
        });

        // Pega user_id E timestamp da URL
        const urlParams = new URLSearchParams(window.location.search);
        const user_id = urlParams.get('user_id');
        const t = urlParams.get('t'); // üÜï PEGA TIMESTAMP

        // Verifica se o link √© v√°lido (agora verifica ambos)
        if (!user_id || !t) {
            document.getElementById('agendarForm').style.display = 'none';
            document.getElementById('resultado').style.display = 'block';
            document.getElementById('resultado').innerHTML = `
                <div class="p-6 rounded-lg error-message">
                    <i data-feather="alert-triangle" class="w-8 h-8 mx-auto mb-3"></i>
                    <h3 class="text-xl font-semibold mb-2">Link Inv√°lido</h3>
                    <p>Este link de agendamento √© inv√°lido ou expirado.</p>
                    <p class="text-sm opacity-80 mt-2">Entre em contato com quem enviou este link.</p>
                </div>
            `;
            feather.replace();
        }

        // M√°scara para telefone
        const phoneMask = IMask(document.getElementById('telefone'), {
            mask: '(00) 00000-0000'
        });

        // üî• CONTROLE DO CHAT FLUTUANTE
        let chatAberto = false;

      
        // üîî FUN√á√ïES PARA CONTROLAR A NOTIFICA√á√ÉO
        function mostrarNotificacao() {
            const badge = document.getElementById('chatBadge');
            badge.classList.remove('hidden');
        }

        function esconderNotificacao() {
            const badge = document.getElementById('chatBadge');
            badge.classList.add('hidden');
        }

        // Mostra notifica√ß√£o quando o chat √© fechado
        function toggleChat() {
            const chat = document.getElementById('chatFlutuante');
            const botao = document.querySelector('.chat-abrir-btn');
            
            if (chatAberto) {
                chat.classList.remove('chat-aberto');
                chat.classList.add('chat-fechado');
                botao.style.display = 'flex';
                // üîî MOSTRA NOTIFICA√á√ÉO AO FECHAR
                setTimeout(mostrarNotificacao, 1000);
            } else {
                chat.classList.remove('chat-fechado');
                chat.classList.add('chat-aberto');
                botao.style.display = 'none';
                // üîî ESCONDE NOTIFICA√á√ÉO AO ABRIR
                esconderNotificacao();
            }
            
            chatAberto = !chatAberto;
            feather.replace();
        }
        
        setTimeout(() => {
            if (!chatAberto) {
                mostrarNotificacao();
            }
        }, 5000);
        
        function adicionarMensagemChat(texto, tipo = 'bot') {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message chat-${tipo}`;
            messageDiv.innerHTML = `<div class="chat-message-content">${texto}</div>`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            feather.replace();
        }

        // üî• CORRE√á√ÉO COMPLETA: Fun√ß√£o carregarHorariosReais
        async function carregarHorariosReais() {
            if (!user_id) {
                adicionarMensagemChat('<strong>Assistente:</strong> Link inv√°lido. N√£o √© poss√≠vel verificar hor√°rios. ‚ùå');
                return;
            }

            // ‚úÖ‚úÖ‚úÖ ADICIONE AQUI - LOADING NO BOT√ÉO
            const carregarBtn = document.getElementById('carregarHorariosBtn');
            carregarBtn.innerHTML = '<div class="loading-spinner"></div> Carregando...';
            carregarBtn.disabled = true;

            adicionarMensagemChat('<strong>Assistente:</strong> Consultando hor√°rios reais do sistema... ‚è≥');

            try {
                // üéØ BUSCA PERFIL REAL - COM TRATAMENTO DE ERRO MELHORADO
                let perfilInfo = null;
                try {
                    console.log('üîç Buscando perfil para user_id:', user_id);
                    const perfilResponse = await fetch(`https://agendamento-ynxr.onrender.com/api/perfil-publico/${user_id}`);
                    
                    console.log('üì° Status da resposta:', perfilResponse.status);
                    
                    if (perfilResponse.ok) {
                        const perfilData = await perfilResponse.json();
                        console.log('üì¶ Dados do perfil recebidos:', perfilData);
                        
                        if (perfilData.success && perfilData.perfil) {
                            perfilInfo = perfilData.perfil;
                            console.log('‚úÖ Perfil carregado com sucesso:', perfilInfo.nome_negocio);
                        } else {
                            console.log('‚ùå Perfil n√£o encontrado ou success=false');
                            adicionarMensagemChat('<strong>Assistente:</strong> Perfil do estabelecimento n√£o encontrado. ‚ùå');
                            return;
                        }
                    } else {
                        console.log('‚ùå Erro HTTP:', perfilResponse.status);
                        throw new Error(`HTTP ${perfilResponse.status}`);
                    }
                } catch (perfilError) {
                    console.error('‚ùå Erro ao buscar perfil:', perfilError);
                    adicionarMensagemChat('<strong>Assistente:</strong> Erro ao carregar informa√ß√µes do estabelecimento. ‚ùå');
                    return;
                }

                // üéØ SE CHEGOU AQUI, TEMOS PERFIL - MOSTRA INFORMA√á√ïES
                adicionarMensagemChat(`<strong>Assistente:</strong> Encontrei o <strong>${perfilInfo.nome_negocio}</strong>! üè™`);
                
                // Mostra hor√°rios de funcionamento
                let infoFuncionamento = `
                    <div class="info-box">
                        <strong>üïí Hor√°rios de Funcionamento:</strong><br>
                `;
                
                Object.keys(perfilInfo.horarios_funcionamento).forEach(dia => {
                    const horario = perfilInfo.horarios_funcionamento[dia];
                    infoFuncionamento += `${formatarDiaNome(dia)}: ${horario.inicio} √†s ${horario.fim}<br>`;
                });
                
                infoFuncionamento += `</div>`;
                adicionarMensagemChat(infoFuncionamento);
                
                // üéØ MOSTRA BLOQUEIOS SE EXISTIREM
                if (perfilInfo.horarios_bloqueados && perfilInfo.horarios_bloqueados.length > 0) {
                    const bloqueiosRecorrentes = perfilInfo.horarios_bloqueados.filter(p => p.tipo === 'recorrente');
                    const bloqueiosDataEspecifica = perfilInfo.horarios_bloqueados.filter(p => p.tipo === 'data_especifica');
                    
                    if (bloqueiosRecorrentes.length > 0) {
                        adicionarMensagemChat(`
                            <div class="info-box" style="background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3);">
                                <strong>üö´ Per√≠odos Bloqueados Fixos:</strong><br>
                                <div style="font-size: 12px; margin-top: 6px;">
                                    ${bloqueiosRecorrentes.map(periodo => 
                                        `‚Ä¢ ${periodo.inicio} - ${periodo.fim}`
                                    ).join('<br>')}
                                </div>
                                <div style="font-size: 11px; margin-top: 4px; color: #fbbf24;">
                                    ‚ö†Ô∏è Estes hor√°rios n√£o estar√£o dispon√≠veis em nenhum dia
                                </div>
                            </div>
                        `);
                    }
                    
                    if (bloqueiosDataEspecifica.length > 0) {
                        adicionarMensagemChat(`
                            <div class="info-box" style="background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3);">
                                <strong>üìÖ Bloqueios em Datas Espec√≠ficas:</strong><br>
                                <div style="font-size: 12px; margin-top: 6px;">
                                    Existem ${bloqueiosDataEspecifica.length} per√≠odos bloqueados em datas espec√≠ficas
                                </div>
                                <div style="font-size: 11px; margin-top: 4px; color: #60a5fa;">
                                    üìç Estes bloqueios aparecer√£o apenas nas datas correspondentes
                                </div>
                            </div>
                        `);
                    }
                } else {
                    adicionarMensagemChat(`
                        <div class="info-box" style="background: rgba(34, 197, 94, 0.1); border-color: rgba(34, 197, 94, 0.3);">
                            <strong>‚úÖ Sem bloqueios:</strong> Todos os hor√°rios est√£o dispon√≠veis!
                        </div>
                    `);
                }
                
                // üéØ AGORA MOSTRA DATAS DISPON√çVEIS INTERATIVAS
                await mostrarProximasDatasDisponiveis(perfilInfo);
                
            } catch (error) {
                console.error('‚ùå Erro geral no chat:', error);
                adicionarMensagemChat(`
                    <div class="info-box" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3);">
                        <strong>‚ùå Erro de conex√£o:</strong><br>
                        N√£o foi poss√≠vel carregar os hor√°rios dispon√≠veis.<br><br>
                        <strong>üí° Solu√ß√£o:</strong> Use o formul√°rio principal para agendar normalmente.
                    </div>
                `);
            } finally {
                // ‚úÖ‚úÖ‚úÖ ADICIONE AQUI - RESTAURA BOT√ÉO (SEMPRE executa)
                const carregarBtn = document.getElementById('carregarHorariosBtn');
                carregarBtn.innerHTML = 'üîç Ver Hor√°rios Dispon√≠veis';
                carregarBtn.disabled = false;
            }
        }

        // üéØ FUN√á√ÉO PARA MOSTRAR PR√ìXIMAS DATAS DISPON√çVEIS (ATUALIZADA)
        async function mostrarProximasDatasDisponiveis(perfilInfo) {
            adicionarMensagemChat('<strong>Assistente:</strong> Calculando pr√≥ximas datas dispon√≠veis... üìÖ');
            
            const diasFuncionamento = perfilInfo.dias_funcionamento;
            
            // üî• CORRE√á√ÉO: Usa data UTC para evitar problemas
            const hoje = new Date();
            const hojeUTC = new Date(Date.UTC(hoje.getFullYear(), hoje.getMonth(), hoje.getDate()));
            
            const proximosDias = [];
            
            // ‚úÖ CORRE√á√ÉO CR√çTICA: Come√ßa de i = 0 (HOJE) em vez de i = 1
            for (let i = 0; i <= 14; i++) { // üî• MUDEI: i = 0 inclui HOJE
                const data = new Date(hojeUTC);
                data.setUTCDate(hojeUTC.getUTCDate() + i);
                
                const diaSemana = data.getUTCDay();
                const nomeDia = obterDiaSemana(diaSemana);
                const nomeDiaLower = nomeDia.toLowerCase();
                
                // Verifica se √© dia de funcionamento
                if (diasFuncionamento.includes(nomeDiaLower)) {
                    const dataISO = data.toISOString().split('T')[0];
                    
                    // üî• DETECTA SE √â HOJE para mostrar label especial
                    const labelDia = i === 0 ? "Hoje" : formatarDiaNome(nomeDiaLower);
                    const dataFormatada = i === 0 ? "Hoje" : formatarData(dataISO);
                    
                    proximosDias.push({
                        data: dataISO,
                        nomeDia: labelDia,
                        dataFormatada: dataFormatada,
                        ehHoje: i === 0 // üî• Flag para identificar hoje
                    });
                    
                    // Limita a 5 dias (incluindo hoje)
                    if (proximosDias.length >= 5) break;
                }
            }
            
            if (proximosDias.length === 0) {
                adicionarMensagemChat('<strong>Assistente:</strong> Nenhuma data dispon√≠vel encontrada para os pr√≥ximos dias. üòï');
                return;
            }
            
            // üî• DESTACA HOJE visualmente
            adicionarMensagemChat(`
                <div class="info-box">
                    <strong>üìÖ Datas Dispon√≠veis:</strong>
                    <div class="datas-grid" style="margin-top: 8px;">
                        ${proximosDias.map(dia => `
                            <button class="data-btn" onclick="selecionarData('${dia.data}')" 
                                    style="display: block; width: 100%; padding: 8px; margin: 4px 0; 
                                           background: ${dia.ehHoje ? 'rgba(34, 197, 94, 0.3)' : 'rgba(59, 130, 246, 0.2)'}; 
                                           border: 1px solid ${dia.ehHoje ? 'rgba(34, 197, 94, 0.5)' : 'rgba(59, 130, 246, 0.4)'}; 
                                           border-radius: 6px; cursor: pointer; text-align: center;
                                           ${dia.ehHoje ? 'font-weight: bold;' : ''}">
                                <strong>${dia.nomeDia}</strong><br>
                                ${dia.dataFormatada}
                                ${dia.ehHoje ? ' üéØ' : ''}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `);
            
            adicionarMensagemChat('<strong>Assistente:</strong> Clique em uma data para ver os hor√°rios dispon√≠veis! üïê');
        }
        
       // üî• ATUALIZAR: Fun√ß√£o quando usu√°rio seleciona uma data (com normaliza√ß√£o de hor√°rios)
async function selecionarData(dataSelecionada) {
    const dataFormatada = formatarData(dataSelecionada);
    adicionarMensagemChat(`<strong>Voc√™:</strong> Selecionou ${dataFormatada}`, 'user');
    
    adicionarMensagemChat('<strong>Assistente:</strong> Verificando hor√°rios dispon√≠veis... üîÑ');

    try {
        // üéØ BUSCA HOR√ÅRIOS DISPON√çVEIS REAIS DO BACKEND
        const response = await fetch(`https://agendamento-ynxr.onrender.com/api/horarios-disponiveis/${user_id}?data=${dataSelecionada}`);
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.success && data.horariosDisponiveis && data.horariosDisponiveis.length > 0) {
                // üÜï NORMALIZA HOR√ÅRIOS: Remove segundos (HH:MM:SS ‚Üí HH:MM)
                const horariosDisponiveisNormalizados = data.horariosDisponiveis.map(horario => 
                    horario.length === 8 ? horario.substring(0, 5) : horario
                );
                
                const horariosOcupadosNormalizados = (data.horariosOcupados || []).map(horario => 
                    horario.length === 8 ? horario.substring(0, 5) : horario
                );
                
                // üÜï FILTRA APENAS HORAS CHEIAS da resposta da API
                const horasCheiasDisponiveis = filtrarHorasCheias(horariosDisponiveisNormalizados);
                const horasCheiasOcupadas = filtrarHorasCheias(horariosOcupadosNormalizados);
                
                if (horasCheiasDisponiveis.length > 0) {
                    mostrarHorariosDisponiveis(
                        dataSelecionada, 
                        horasCheiasDisponiveis, 
                        horasCheiasOcupadas,
                        data.periodosBloqueados
                    );
                    
                } else {
                    adicionarMensagemChat(`
                        <div class="info-box" style="background: rgba(248, 113, 113, 0.1); border-color: rgba(248, 113, 113, 0.3);">
                            <strong>‚ùå Nenhuma hora cheia dispon√≠vel</strong><br>
                            Todos os hor√°rios de hora em hora est√£o ocupados ou bloqueados.<br><br>
                            <em>üí° Tente selecionar outra data</em>
                        </div>
                    `);
                }
            } else {
                // Se n√£o tiver hor√°rios dispon√≠veis
                let motivo = data.motivo || "Todos os hor√°rios est√£o ocupados ou bloqueados";
                adicionarMensagemChat(`
                    <div class="info-box" style="background: rgba(248, 113, 113, 0.1); border-color: rgba(248, 113, 113, 0.3);">
                        <strong>‚ùå Nenhum hor√°rio dispon√≠vel</strong><br>
                        ${motivo}<br><br>
                        <em>üí° Tente selecionar outra data</em>
                    </div>
                `);
            }
        } else {
            // Fallback se a rota n√£o funcionar
            await gerarHorariosBasePerfil(dataSelecionada);
        }
        
    } catch (error) {
        console.error('Erro ao buscar hor√°rios:', error);
        // Fallback em caso de erro
        await gerarHorariosBasePerfil(dataSelecionada);
    }
}

  // ‚úÖ‚úÖ‚úÖ CORRE√á√ÉO COMPLETA: Fun√ß√£o mostrarHorariosDisponiveis corrigida
function mostrarHorariosDisponiveis(data, horariosDisponiveis, horariosOcupados = [], periodosBloqueados = []) {
    // üÜï NORMALIZA TODOS OS HOR√ÅRIOS PARA HH:MM
    const horariosDisponiveisNormalizados = horariosDisponiveis.map(horario => 
        horario.length === 8 ? horario.substring(0, 5) : horario
    );
    
    const horariosOcupadosNormalizados = horariosOcupados.map(horario => 
        horario.length === 8 ? horario.substring(0, 5) : horario
    );

    // üÜï CR√çTICO: Remove hor√°rios no PASSADO (usando arrays NORMALIZADOS)
    const agora = new Date();
    const horariosFuturos = horariosDisponiveisNormalizados.filter(horario => {
        const dataHorario = new Date(`${data}T${horario}`);
        return dataHorario > agora;
    });

    // ‚úÖ‚úÖ‚úÖ AGORA SIM: Verifica se h√° hor√°rios futuros
    if (horariosFuturos.length === 0) {
        adicionarMensagemChat(`
            <div class="info-box" style="background: rgba(248, 113, 113, 0.1); border-color: rgba(248, 113, 113, 0.3);">
                <strong>‚ùå Nenhum hor√°rio dispon√≠vel</strong><br>
                ${horariosDisponiveis.length > 0 ? 'Todos os hor√°rios est√£o no passado.' : 'Todos os hor√°rios est√£o ocupados ou bloqueados.'}<br><br>
                <em>üí° Tente selecionar outra data</em>
            </div>
        `);
        return;
    }

    // üéØ CORRE√á√ÉO: Converte estrutura nova para array simples (compatibilidade)
    let periodosArray = [];
    if (periodosBloqueados && typeof periodosBloqueados === 'object') {
        if (periodosBloqueados.recorrentes) {
            periodosArray = periodosArray.concat(periodosBloqueados.recorrentes);
        }
        if (periodosBloqueados.data_especifica) {
            periodosArray = periodosArray.concat(periodosBloqueados.data_especifica);
        }
    } else {
        periodosArray = periodosBloqueados || [];
    }

    // üéØ ORGANIZA HOR√ÅRIOS POR PER√çODOS BLOQUEADOS (usa os REALMENTE dispon√≠veis e futuros)
    let horariosAgrupados = agruparHorariosPorPeriodo(horariosFuturos, periodosArray);
    
    // ‚úÖ‚úÖ‚úÖ CORRE√á√ÉO CR√çTICA: Remove hor√°rios que est√£o em horariosOcupados (usando NORMALIZADOS)
    horariosAgrupados = horariosAgrupados.map(grupo => {
        return {
            ...grupo,
            horarios: grupo.horarios.filter(horario => !horariosOcupadosNormalizados.includes(horario))
        };
    }).filter(grupo => grupo.horarios.length > 0); // Remove grupos vazios

    if (horariosAgrupados.length === 0) {
        adicionarMensagemChat(`
            <div class="info-box" style="background: rgba(248, 113, 113, 0.1); border-color: rgba(248, 113, 113, 0.3);">
                <strong>‚ùå Nenhum hor√°rio dispon√≠vel</strong><br>
                Todos os hor√°rios est√£o ocupados ou bloqueados.<br><br>
                <em>üí° Tente selecionar outra data</em>
            </div>
        `);
        return;
    }

    adicionarMensagemChat(`
        <div class="info-box">
            <strong>üïê Hor√°rios Dispon√≠veis para ${formatarData(data)}:</strong>
    `);

    // üéØ MOSTRA HOR√ÅRIOS DISPON√çVEIS AGRUPADOS (apenas os futuros e n√£o ocupados)
    horariosAgrupados.forEach(grupo => {
        if (grupo.horarios.length > 0) {
            let tituloGrupo = '';
            
            if (grupo.periodoAnterior && grupo.periodoPosterior) {
                tituloGrupo = `<div style="font-size: 11px; color: #fbbf24; margin-bottom: 4px;">‚è≥ Per√≠odo livre entre bloqueios</div>`;
            }
            
            adicionarMensagemChat(`
                ${tituloGrupo}
                <div class="horarios-grid" style="margin-top: 6px; margin-bottom: 10px;">
                    ${grupo.horarios.map(horario => {
                        // ‚úÖ‚úÖ‚úÖ AGORA S√ì MOSTRA HOR√ÅRIOS REALMENTE DISPON√çVEIS
                        // (j√° foram filtrados os ocupados e passados)
                        return `
                            <button class="horario-btn" onclick="selecionarHorarioChat('${data}', '${horario}')"
                                    style="padding: 8px 12px; background: rgba(34, 197, 94, 0.2); 
                                           border: 1px solid rgba(34, 197, 94, 0.4); 
                                           border-radius: 6px; cursor: pointer; transition: all 0.3s;">
                                <strong>${horario}</strong>
                            </button>
                        `;
                    }).join('')}
                </div>
            `);
        }
    });

    adicionarMensagemChat(`</div>`);

    // üéØ MOSTRA ESTAT√çSTICAS ATUALIZADAS (usando arrays NORMALIZADOS)
    const totalHorariosFuturos = horariosFuturos.length;
    const totalHorariosPassados = horariosDisponiveisNormalizados.length - totalHorariosFuturos;
    const totalHorariosOcupados = horariosOcupadosNormalizados.length;
    const totalHorariosMostrados = horariosAgrupados.reduce((total, grupo) => total + grupo.horarios.length, 0);

    adicionarMensagemChat(`
        <div class="info-box" style="background: rgba(34, 197, 94, 0.1); border-color: rgba(34, 197, 94, 0.3);">
            <strong>üìä Status Final:</strong><br>
            ‚úÖ <strong>${totalHorariosMostrados}</strong> hor√°rios dispon√≠veis<br>
            ‚è∞ <strong>${totalHorariosPassados}</strong> hor√°rios no passado<br>
            ‚ùå <strong>${totalHorariosOcupados}</strong> hor√°rios ocupados<br>
            üö´ <strong>${periodosArray.length}</strong> per√≠odos bloqueados<br>
            <div style="font-size: 11px; margin-top: 4px; color: #60a5fa;">
                üí° Filtrados: ${totalHorariosFuturos - totalHorariosMostrados} hor√°rios futuros mas ocupados
            </div>
        </div>
    `);
}

           

        // üÜï FUN√á√ÉO: Agrupa hor√°rios considerando per√≠odos bloqueados
        function agruparHorariosPorPeriodo(horariosDisponiveis, periodosBloqueados) {
            if (!periodosBloqueados || periodosBloqueados.length === 0) {
                // Se n√£o h√° per√≠odos bloqueados, retorna um √∫nico grupo
                return [{ horarios: horariosDisponiveis }];
            }
            
            const grupos = [];
            let horariosRestantes = [...horariosDisponiveis];
            
            // Ordena per√≠odos bloqueados por hor√°rio de in√≠cio
            const periodosOrdenados = [...periodosBloqueados].sort((a, b) => a.inicio.localeCompare(b.inicio));
            
            // Para cada per√≠odo bloqueado, cria grupos antes/depois
            periodosOrdenados.forEach((periodo, index) => {
                const periodoAnterior = index > 0 ? periodosOrdenados[index - 1] : null;
                const periodoPosterior = periodo;
                
                // Hor√°rios antes do per√≠odo bloqueado atual
                const horariosAntes = horariosRestantes.filter(horario => horario < periodo.inicio);
                
                if (horariosAntes.length > 0) {
                    grupos.push({
                        horarios: horariosAntes,
                        periodoAnterior: periodoAnterior,
                        periodoPosterior: periodoPosterior
                    });
                    
                    // Remove esses hor√°rios dos restantes
                    horariosRestantes = horariosRestantes.filter(horario => horario >= periodo.inicio);
                }
                
                // Remove hor√°rios que est√£o dentro do per√≠odo bloqueado
                horariosRestantes = horariosRestantes.filter(horario => 
                    horario < periodo.inicio || horario >= periodo.fim
                );
            });
            
            // Adiciona hor√°rios restantes (ap√≥s o √∫ltimo per√≠odo bloqueado)
            if (horariosRestantes.length > 0) {
                grupos.push({
                    horarios: horariosRestantes,
                    periodoAnterior: periodosOrdenados[periodosOrdenados.length - 1],
                    periodoPosterior: null
                });
            }
            
            return grupos;
        }
        
      // üÜï FUN√á√ÉO: Filtra apenas horas cheias (00 minutos) - compat√≠vel com HH:MM e HH:MM:SS
function filtrarHorasCheias(horarios) {
    return horarios.filter(horario => {
        // ‚úÖ Normaliza para HH:MM primeiro
        const horarioNormalizado = horario.length === 8 ? horario.substring(0, 5) : horario;
        const minutos = horarioNormalizado.split(':')[1];
        // ‚úÖ Permite apenas: 00 minutos (horas cheias)
        return minutos === '00';
    });
}
        
        // üî• SUBSTITUIR: Fun√ß√£o corrigida que usa APENAS HORAS CHEIAS
        async function gerarHorariosBasePerfil(dataSelecionada) {
            try {
                const perfilResponse = await fetch(`https://agendamento-ynxr.onrender.com/api/perfil-publico/${user_id}`);
                
                if (perfilResponse.ok) {
                    const perfilData = await perfilResponse.json();
                    if (perfilData.success && perfilData.perfil) {
                        const perfilInfo = perfilData.perfil;
                        const diaSemana = new Date(dataSelecionada).getDay();
                        const nomeDia = obterDiaSemana(diaSemana).toLowerCase();
                        
                        if (perfilInfo.horarios_funcionamento && perfilInfo.horarios_funcionamento[nomeDia]) {
                            const horarioDia = perfilInfo.horarios_funcionamento[nomeDia];
                            
                            // Gera hor√°rios com intervalo de 30 minutos (para ter mais op√ß√µes)
                            const todosHorarios = gerarHorariosIntervalo(
                                horarioDia.inicio, 
                                horarioDia.fim,
                                30 // Gera de 30 em 30 minutos
                            );
                            
                            // üÜï FILTRA APENAS HORAS CHEIAS (00 minutos)
                            const horasCheias = filtrarHorasCheias(todosHorarios);
                            
                            console.log(`üïí Hor√°rios para ${nomeDia}:`, {
                                todos: todosHorarios,
                                horas_cheias: horasCheias
                            });
                            
                            // üÜï FILTRA HOR√ÅRIOS BLOQUEADOS
                            let horariosDisponiveis = [...horasCheias];
                            
                            if (perfilInfo.horarios_bloqueados && perfilInfo.horarios_bloqueados.length > 0) {
                                horariosDisponiveis = horariosDisponiveis.filter(horario => {
                                    const horarioCompleto = `${dataSelecionada}T${horario}`;
                                    const dataHorario = new Date(horarioCompleto);
                                    
                                    for (const periodo of perfilInfo.horarios_bloqueados) {
                                        const inicioPeriodo = new Date(`${dataSelecionada}T${periodo.inicio}`);
                                        const fimPeriodo = new Date(`${dataSelecionada}T${periodo.fim}`);
                                        
                                        if (dataHorario >= inicioPeriodo && dataHorario < fimPeriodo) {
                                            return false; // Hor√°rio bloqueado
                                        }
                                    }
                                    return true; // Hor√°rio dispon√≠vel
                                });
                            }
                            
                            mostrarHorariosDisponiveis(
                                dataSelecionada, 
                                horariosDisponiveis, 
                                [], // N√£o temos info de ocupados no fallback
                                perfilInfo.horarios_bloqueados || []
                            );
                            return;
                        }
                    }
                }
                
                // üî• CORRE√á√ÉO: Fallback com APENAS HORAS CHEIAS
                const todosHorarios = gerarHorariosIntervalo('09:00', '16:00', 30);
                const horasCheias = filtrarHorasCheias(todosHorarios);
                mostrarHorariosDisponiveis(dataSelecionada, horasCheias);
                
            } catch (error) {
                console.error('Erro no fallback:', error);
                const todosHorarios = gerarHorariosIntervalo('09:00', '16:00', 30);
                const horasCheias = filtrarHorasCheias(todosHorarios);
                mostrarHorariosDisponiveis(dataSelecionada, horasCheias);
            }
        }

        // üî• ATUALIZAR: Fun√ß√£o gerarHorariosIntervalo corrigida
        function gerarHorariosIntervalo(inicio, fim, intervaloMinutos) {
            const horarios = [];
            const [horaInicio, minutoInicio] = inicio.split(':').map(Number);
            const [horaFim, minutoFim] = fim.split(':').map(Number);
            
            let horaAtual = horaInicio;
            let minutoAtual = minutoInicio;
            
            // üî• CORRE√á√ÉO: Para ANTES de chegar no hor√°rio de fim
            while (horaAtual < horaFim || (horaAtual === horaFim && minutoAtual < minutoFim)) {
                const horario = `${horaAtual.toString().padStart(2, '0')}:${minutoAtual.toString().padStart(2, '0')}`;
                horarios.push(horario);
                
                // Adiciona intervalo
                minutoAtual += intervaloMinutos;
                if (minutoAtual >= 60) {
                    horaAtual += Math.floor(minutoAtual / 60);
                    minutoAtual = minutoAtual % 60;
                }
                
                // üî• CORRE√á√ÉO CR√çTICA: Para se passar do hor√°rio de fim
                if (horaAtual > horaFim || (horaAtual === horaFim && minutoAtual >= minutoFim)) {
                    break;
                }
            }
            
            console.log(`üìÖ Hor√°rios gerados: ${inicio} - ${fim} =>`, horarios);
            return horarios;
        }

        // üéØ FUN√á√ÉO AUXILIAR - OBT√âM DIA DA SEMANA
        function obterDiaSemana(diaNumero) {
            const dias = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];
            return dias[diaNumero];
        }

        // üéØ FUN√á√ÉO PARA SELECIONAR VIA CHAT (AGORA SEM VALIDA√á√ÉO, J√Å QUE OS BOT√ïES EST√ÉO BLOQUEADOS)
        function selecionarHorarioChat(data, horario) {
            // üî• CORRE√á√ÉO DO FUSO HOR√ÅRIO - garante que a data seja mantida
            const dataCorrigida = corrigirFusoHorario(data);
            
            document.getElementById('data').value = dataCorrigida;
            document.getElementById('horario').value = horario;
            
            adicionarMensagemChat(`<strong>Voc√™:</strong> Selecionou ${formatarData(data)} √†s ${horario}`, 'user');
            adicionarMensagemChat('<strong>Assistente:</strong> Perfeito! Agora preencha seus dados no formul√°rio principal. ‚úÖ');
            
            // Foca no formul√°rio
            setTimeout(() => {
                document.getElementById('agendarForm').scrollIntoView({ behavior: 'smooth' });
            }, 500);
        }

        // üî• FUN√á√ÉO PARA CORRIGIR FUSO HOR√ÅRIO
        function corrigirFusoHorario(dataString) {
            // Cria a data no hor√°rio UTC para evitar problemas de fuso
            const data = new Date(dataString + 'T00:00:00Z');
            
            // Formata de volta para YYYY-MM-DD sem ajuste de fuso
            const ano = data.getUTCFullYear();
            const mes = String(data.getUTCMonth() + 1).padStart(2, '0');
            const dia = String(data.getUTCDate()).padStart(2, '0');
            
            return `${ano}-${mes}-${dia}`;
        }
        
        // üî• FUN√á√ïES AUXILIARES (ATUALIZADAS)
        function formatarDiaNome(dia) {
            const dias = {
                'segunda': 'Segunda',
                'terca': 'Ter√ßa', 
                'quarta': 'Quarta',
                'quinta': 'Quinta',
                'sexta': 'Sexta',
                'sabado': 'S√°bado',
                'domingo': 'Domingo'
            };
            return dias[dia] || dia;
        }

        function formatarData(dataString) {
            // üî• CORRE√á√ÉO: Usa UTC para evitar problemas de fuso
            const data = new Date(dataString + 'T00:00:00Z');
            return data.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
        }

        function obterDiaSemana(diaNumero) {
            const dias = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];
            return dias[diaNumero];
        }

        // üî• INICIALIZA√á√ÉO
        feather.replace();

        // Abre o chat automaticamente ap√≥s 2 segundos
        setTimeout(() => {
            if (!chatAberto) {
                toggleChat();
            }
        }, 2000);

        // Define data m√≠nima como hoje
        document.getElementById('data').min = new Date().toISOString().split('T')[0];

        // Submit do formul√°rio
        document.getElementById('agendarForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.querySelector('#agendarForm button[type="submit"]');
            const agendarText = document.getElementById('agendarText');
            const agendarSpinner = document.getElementById('agendarSpinner');
            
            // Mostra loading
            agendarText.textContent = 'Agendando...';
            agendarSpinner.classList.remove('hidden');
            submitBtn.disabled = true;

            const agendamento = {
                nome: document.getElementById('nome').value,
                email: document.getElementById('email').value, // ‚úÖ mant√©m min√∫sculo
                telefone: document.getElementById('telefone').value,
                data: document.getElementById('data').value,
                horario: document.getElementById('horario').value,
                user_id: user_id,
                t: t
            };
            
            // ‚úÖ‚úÖ‚úÖ ADICIONE AQUI - VALIDA√á√ÉO DE DATA NO PASSADO
            const dataAgendamento = new Date(`${agendamento.data}T${agendamento.horario}`);
            const agora = new Date();

            if (dataAgendamento < agora) {
                document.getElementById('resultado').style.display = 'block';
                document.getElementById('resultado').innerHTML = `
                    <div class="p-6 rounded-lg error-message">
                        <i data-feather="clock" class="w-12 h-12 mx-auto mb-4"></i>
                        <h3 class="text-xl font-semibold mb-2">Data Inv√°lida</h3>
                        <p>N√£o √© poss√≠vel agendar no passado.</p>
                    </div>
                `;
                feather.replace();
                
                // Restaura bot√£o
                agendarText.textContent = 'Agendar Compromisso';
                agendarSpinner.classList.add('hidden');
                submitBtn.disabled = false;
                return; // Para a execu√ß√£o
            }
            
            // üî• CORRIJA A VERIFICA√á√ÉO (usa 'email' min√∫sculo):
            if(!agendamento.email || agendamento.email.trim() === '') {
                agendamento.email = 'N√£o informado'; // ‚úÖ 'email' min√∫sculo
            }
            
            try {
                const response = await fetch('https://agendamento-ynxr.onrender.com/agendamento-publico', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(agendamento)
                });

                const result = await response.json();
                
                // Mostra resultado
                document.getElementById('resultado').style.display = 'block';
                
                if (result.success) {
                   document.getElementById('resultado').innerHTML = `
    <div class="p-6 rounded-lg success-message">
        <i data-feather="check-circle" class="w-12 h-12 mx-auto mb-4"></i>
        <h3 class="text-xl font-semibold mb-2">Agendamento Confirmado!</h3>
        <p class="mb-4">${result.msg}</p>
        <div class="bg-white/10 rounded-lg p-4 text-left">
            <p><strong>Nome:</strong> ${agendamento.nome}</p>
            <p><strong>Telefone:</strong> ${agendamento.telefone}</p>
            <p><strong>Data:</strong> ${agendamento.data}</p>
            <p><strong>Hor√°rio:</strong> ${agendamento.horario}</p>
        </div>
    </div>
`;
                    document.getElementById('agendarForm').reset();
                } else {
                    // üî• TRATAMENTO DE ERRO MELHORADO
                    let mensagemErro = result.msg || "Erro ao agendar";
                    
                    if (response.status === 400) {
                        if (mensagemErro.includes("Hor√°rio indispon√≠vel")) {
                            mensagemErro = "‚ùå " + mensagemErro;
                        } else if (mensagemErro.includes("Fora do hor√°rio")) {
                            mensagemErro = "üïí " + mensagemErro;
                        } else if (mensagemErro.includes("bloqueado")) {
                            mensagemErro = "üö´ " + mensagemErro;
                        } else if (mensagemErro.includes("passado")) {
                            mensagemErro = "‚è∞ " + mensagemErro;
                        } else if (mensagemErro.includes("expirado")) {
                            mensagemErro = "üîó " + mensagemErro;
                        }
                    }
                    
                    document.getElementById('resultado').innerHTML = `
                        <div class="p-6 rounded-lg error-message">
                            <i data-feather="alert-circle" class="w-12 h-12 mx-auto mb-4"></i>
                            <h3 class="text-xl font-semibold mb-2">${response.status === 400 ? 'Dados Inv√°lidos' : 'Erro no Agendamento'}</h3>
                            <p>${mensagemErro}</p>
                        </div>
                    `;
                }
                
                feather.replace();
                
            } catch (error) {
                document.getElementById('resultado').style.display = 'block';
                document.getElementById('resultado').innerHTML = `
                    <div class="p-6 rounded-lg error-message">
                        <i data-feather="wifi-off" class="w-12 h-12 mx-auto mb-4"></i>
                        <h3 class="text-xl font-semibold mb-2">Erro de Conex√£o</h3>
                        <p>Erro ao agendar. Verifique sua conex√£o e tente novamente.</p>
                    </div>
                `;
                feather.replace();
            } finally {
                // Restaura bot√£o
                agendarText.textContent = 'Agendar Compromisso';
                agendarSpinner.classList.add('hidden');
                submitBtn.disabled = false;
            }
        });

        // Anima√ß√µes para os campos
        document.querySelectorAll('.input-field').forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement.classList.add('ring-2', 'ring-indigo-500/30');
            });
            
            input.addEventListener('blur', function() {
                this.parentElement.classList.remove('ring-2', 'ring-indigo-500/30');
            });
        });
    </script>
</body>
</html>
